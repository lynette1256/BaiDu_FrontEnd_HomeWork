<!DOCTYPE html>
<html>
<head>
	<title>Email Exercise3添加键盘响应及输入框焦点优化</title>
	
	<link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
	<p>邮箱后缀提示模拟</p>
	<div class="wrapper">
		<input id="email-input" type="text" name="emailinput">
    	<ul id="email-sug-wrapper" class="email-sug">
    	</ul>
	</div>

	<script type="text/javascript">
		document.getElementById("email-input").focus();
		var postfixList = ['163.com', 'gmail.com', '126.com', 'qq.com', '263.net'];
		//邮箱补全列表
		var email_input = document.getElementById("email-input"); //输入内容
		var email_sug = document.getElementById("email-sug-wrapper"); //提示后缀
		var nowSelectTipIndex = 0; //记录光标的位置

		email_sug.addEventListener("click", function(event) { //下拉补全邮箱框的点击事件获取函数
			//事件代理，监听父级点击事件，通过target获取当前li
			var event = event || window.event;
			var target = event.target || event.srcElement;
			if(target.nodeName.toLowerCase() == "li"){
				hide();
				document.getElementById("email-input").focus();  //聚焦操作需要在return之前进行，才有效
				return email_input.value = htmlDecode(target.innerHTML);
			}
		});


		document.addEventListener("keydown", function(event) {
			var event = event || window.event;  //获取到事件
			var key = event.keyCode; //获取到键盘按键
			console.log(key);
			var list = document.getElementsByTagName("li"); //获取li下拉列表的全部元素
			//向下键
			if(key == 40){
				for(var i = 0; i < list.length; i++){
					list[i].setAttribute("class", "");
				}//为li元素添加 class 
				nowSelectTipIndex ++; //每按键一次，计数器自增
				if(nowSelectTipIndex + 1 > list.length){
					nowSelectTipIndex = 0; //当光标移动到最后一个li列表时
				}
				list[nowSelectTipIndex].setAttribute("class", "active"); //为当前选中的li增加属性active
			}
			//向上键
			if(key == 38){
				for(var i = 0; i < list.length; i++){
					list[i].setAttribute("class", "");
				}
				nowSelectTipIndex --;
				if(nowSelectTipIndex < 0){
					nowSelectTipIndex = list.length - 1;
				}
				list[nowSelectTipIndex].setAttribute("class", "active");
			}
			//回车键
			if(key == 13){
				var x = document.getElementsByClassName("active");//获取到active的文本信息
				email_input.value = htmlDecode(x[0].innerHTML);//去除输入的html标签
				hide();//隐藏输入框
			}

			if(key == 27){
				email_input.setSelectionRange(0, -1);
				hide();
			}
		});

		function htmlDecode(text) {  //解码
			//动态创建一个容器标签元素div
			var temp = document.createElement('div');
			// 将text文本赋值给标签的innerHTML
			temp.innerHTML = text;
			//返回这个元素的innerHTML或者textContext，得到经过HTML解码的字符串。
			var output = temp.innerText || temp.textContent;
			//垃圾回收机制
			temp = null;
			return output;
		}
 
		function htmlEncode(text) {  //编码
			//动态创建一个容器标签元素div
			var temp = document.createElement('div');
			//将要转换的字符串设置为这个元素的innerText或者textContent
			(temp.textContent != undefined) ? (temp.textContent = text) : (temp.textContent = text);
			//返回这个元素的innerHTML，得到经过HTML编码转换的字符串
			var output = temp.innerHTML;
			temp = null;
			return output;
		}

		email_input.addEventListener("input", function() {
			//console.log("keydown test");
			getInput(); //获取用户输入信息
			displayDef();
			//addAddress(); //添加后缀，生成填充内容
			addToWrapper();
		});

		function getInput() { //获取用户输入
			var emailText = email_input.value.split(" ").join(""); //删除空格，得到字符串
			// console.log(emailText);

			return emailText;
		}

		function postlist(userinput){ 
			//var userinput = getInput();
			var newpostlist = new Array();
			if ( userinput.search('@') != 0 ) { //如果输入的字符串有@符号，则进行如下操作
				var len = userinput.search("@"); //找到输入字符串中“@”的位置
				var x = userinput.substring( len + 1, userinput.length );//获取用户输入字符串@后面的内容
				for (var i = 0; i < postfixList.length; i++){
					if(postfixList[i].search(x) == 0){ //如果是正确的后缀一部分
						newpostlist.push(postfixList[i]) //则将这部分包含的邮箱后缀加入到新建补充列表
					}
				}
				if(x === '' || newpostlist == ''){
					return postfixList; //如果@后无其他字符或者新建补充列表空，则返回原列表
				}
				return newpostlist;
			} else { //如果没有@，则直接返回备选邮箱补充列表
				return postfixList;
			}
		}

		function addAddress(){  //将填充内容和邮箱用户名连接
			//console.log(postlist());
			var emailText = htmlEncode(getInput());
			var newPost = postlist(emailText);
			var tips = new Array(); //提示框数组
			if ( emailText.indexOf("@") != -1 ) {
				var p = emailText.slice( 0, emailText.indexOf("@") );
				for ( i = 0; i < newPost.length; i++ ) {
					tips[i] = p + "@" + newPost[i];
				}
			} else {
				for ( i = 0; i < newPost.length; i++ ) {
					tips[i] = emailText + "@" + newPost[i];
				}
			}
			// console.log(tips);
			return tips;
		}

		function addToWrapper(){
			var tips = addAddress(); //根据提示生成的各个数组
			while(email_sug.hasChildNodes()) { //清除之前的列表内容
				email_sug.removeChild(email_sug.firstChild);
			}

			for(var i = 0; i < tips.length; i++){
				var tip_li = document.createElement("li");
				tip_li.innerHTML = tips[i];
				email_sug.appendChild(tip_li);
				//为元素节点添加文本节点，为ul添加li节点
			}
		}

		function displayDef() {
			if(getInput() == ""){
				hide();
			} else{
				display();
			}
		}
		function hide() { //隐藏下拉节点
			email_sug.style.display = "none";
		}

		function display() { //显示下拉节点
			email_sug.style.display = "block";
		}

		//showAddress();
		//console.log(email_input);



	</script>
</body>
</html>